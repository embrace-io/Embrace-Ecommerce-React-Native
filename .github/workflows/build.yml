name: Build Test Artifacts

# Triggers on push to main or manual dispatch
on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_NAME: "EmbraceEcommerceRN"
  SCHEME_NAME: "EmbraceEcommerceRN"
  XCODE_VERSION: "16.4"
  NODE_VERSION: "20"
  DERIVED_DATA_PATH: "DerivedData"

# Prevent multiple builds from running simultaneously
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build for Testing
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version
          swift --version

      - name: Install npm dependencies
        run: |
          # Update package.json to use published Embrace packages for CI
          # (local file references won't work in CI)
          npm pkg set dependencies.@embrace-io/react-native="^5.0.0"
          npm pkg set dependencies.@embrace-io/react-native-tracer-provider="^5.0.0"
          npm install

      - name: Configure Embrace iOS App ID
        run: |
          if [[ -n "${{ vars.EMBRACE_IOS_APP_ID }}" ]]; then
            # Create embrace.config.ts from template with CI values
            cat > src/config/embrace.config.ts << EOF
          export const EMBRACE_CONFIG = {
            ios: {
              appId: '${{ vars.EMBRACE_IOS_APP_ID }}',
            },
            android: {
              appId: '${{ vars.EMBRACE_ANDROID_APP_ID }}',
            },
          };
          EOF
            echo "Embrace config created with iOS App ID"
          else
            echo "ERROR: EMBRACE_IOS_APP_ID variable not found in repository variables"
            echo "Please add EMBRACE_IOS_APP_ID to your repository variables at: Settings > Secrets and variables > Actions > Variables"
            exit 1
          fi

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        working-directory: ios
        run: |
          pod install --repo-update

      - name: Find simulator
        id: find_simulator
        run: |
          SIMULATOR_UDID=$(xcrun simctl list devices available | grep "iPhone 16" | grep -v "Plus\|Pro" | head -1 | grep -o '[A-F0-9-]\{36\}')
          if [[ -z "$SIMULATOR_UDID" ]]; then
            echo "iPhone 16 simulator not found, trying any iPhone"
            SIMULATOR_UDID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -o '[A-F0-9-]\{36\}')
          fi
          echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          echo "Found simulator: $SIMULATOR_UDID"

      - name: Build for testing
        working-directory: ios
        run: |
          xcodebuild build-for-testing \
            -workspace "${{ env.PROJECT_NAME }}.xcworkspace" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -destination "platform=iOS Simulator,id=${{ steps.find_simulator.outputs.simulator_udid }}" \
            -derivedDataPath "${{ env.DERIVED_DATA_PATH }}" \
            -configuration Debug \
            -skipMacroValidation \
            -allowProvisioningUpdates \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Prepare artifacts
        id: prepare_artifacts
        working-directory: ios
        run: |
          echo "Build products:"
          ls -la "${{ env.DERIVED_DATA_PATH }}/Build/Products/"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-build-artifacts
          path: |
            ios/${{ env.DERIVED_DATA_PATH }}/Build/Products/
          retention-days: 7
          if-no-files-found: error

      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ env.PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode:** ${{ env.XCODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js:** ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts:** test-build-artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts are available for 7 days for use by scheduled test workflows." >> $GITHUB_STEP_SUMMARY
