name: One Simulator (Session Stitching)

# Runs app multiple times sequentially on ONE simulator to create multiple sessions
# for the same device. This enables session stitching in the Embrace dashboard.
# Similar to the native iOS one-simulator.yml approach.

on:
  schedule:
    # Run every 2 hours (offset by 1 hour from ci-scheduled.yml)
    # Combined with ci-scheduled.yml, this achieves ~50% stitched / 50% non-stitched
    - cron: '30 */2 * * *'
  workflow_dispatch:

env:
  PROJECT_NAME: "EmbraceEcommerceRN"
  SCHEME_NAME: "EmbraceEcommerceRN"
  XCODE_VERSION: "16.4"
  NODE_VERSION: "20"
  DEVICE_NAME: "iPhone 16"

concurrency:
  group: one-simulator-sessions
  cancel-in-progress: false

jobs:
  generate-stitched-sessions:
    name: "Generate Stitched Sessions"
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: Download build artifacts
        id: check_artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Attempting to download artifacts from build.yml workflow..."

          RUN_ID=$(gh run list --workflow=build.yml --status=success --limit=1 --json databaseId --jq '.[0].databaseId' 2>/dev/null || echo "")

          if [[ -n "$RUN_ID" ]]; then
            echo "Found successful build run: $RUN_ID"
            mkdir -p ios/DerivedData/Build/Products
            gh run download "$RUN_ID" --name test-build-artifacts --dir ios/DerivedData/Build/Products 2>/dev/null || true
          fi

          if [[ -d "ios/DerivedData/Build/Products" ]] && [[ -n "$(ls -A ios/DerivedData/Build/Products 2>/dev/null)" ]]; then
            echo "artifacts_found=true" >> $GITHUB_OUTPUT
            echo "Artifacts downloaded successfully"
            ls -la ios/DerivedData/Build/Products/
          else
            echo "artifacts_found=false" >> $GITHUB_OUTPUT
            echo "No artifacts found, will build from source"
          fi

      - name: Install npm dependencies (if building from source)
        if: steps.check_artifacts.outputs.artifacts_found != 'true'
        run: |
          npm pkg set dependencies.@embrace-io/react-native="^5.0.0"
          npm pkg set dependencies.@embrace-io/react-native-tracer-provider="^5.0.0"
          npm install

      - name: Configure Embrace iOS App ID
        run: |
          if [[ -n "${{ vars.EMBRACE_IOS_APP_ID }}" ]]; then
            cat > src/config/embrace.config.ts << EOF
          export const EMBRACE_CONFIG = {
            ios: {
              appId: '${{ vars.EMBRACE_IOS_APP_ID }}',
            },
            android: {
              appId: '${{ vars.EMBRACE_ANDROID_APP_ID }}',
            },
          };
          EOF
            echo "Embrace config created"
          else
            echo "ERROR: EMBRACE_IOS_APP_ID variable not found"
            exit 1
          fi

      - name: Cache CocoaPods
        if: steps.check_artifacts.outputs.artifacts_found != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods (if building from source)
        if: steps.check_artifacts.outputs.artifacts_found != 'true'
        working-directory: ios
        run: |
          rm -f Podfile.lock
          pod install --repo-update

      - name: Setup simulator
        id: setup_simulator
        run: |
          SIMULATOR_UDID=$(xcrun simctl list devices available | grep "${{ env.DEVICE_NAME }}" | grep -v "Plus\|Pro" | head -1 | grep -o '[A-F0-9-]\{36\}')
          if [[ -z "$SIMULATOR_UDID" ]]; then
            echo "Simulator not found, trying any iPhone"
            SIMULATOR_UDID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -o '[A-F0-9-]\{36\}')
          fi
          echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          echo "Found simulator: $SIMULATOR_UDID"

          xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || true
          xcrun simctl bootstatus "$SIMULATOR_UDID" -b
          echo "Simulator booted"

      - name: Build from source (fallback if no artifacts)
        if: steps.check_artifacts.outputs.artifacts_found != 'true'
        working-directory: ios
        run: |
          echo "Building from source (no cached artifacts available)"
          xcodebuild build \
            -workspace "${{ env.PROJECT_NAME }}.xcworkspace" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
            -derivedDataPath "DerivedData" \
            -configuration Debug \
            -skipMacroValidation \
            -allowProvisioningUpdates \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Run multiple sessions on same simulator (creates stitched sessions)
        env:
          SIMULATOR_UDID: ${{ steps.setup_simulator.outputs.simulator_udid }}
        run: |
          chmod +x scripts/run-multiple-sessions.sh
          ./scripts/run-multiple-sessions.sh

      - name: Cleanup
        if: always()
        run: |
          killall Simulator 2>/dev/null || true
          xcrun simctl shutdown "${{ steps.setup_simulator.outputs.simulator_udid }}" 2>/dev/null || true

      - name: Session summary
        run: |
          echo "## Stitched Sessions Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Device:** ${{ env.DEVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sessions Created:** Multiple (stitched)" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Source:** one-simulator-stitched" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Multiple sessions were created on the same device (IDFV)." >> $GITHUB_STEP_SUMMARY
          echo "Check the Embrace dashboard to see stitched sessions." >> $GITHUB_STEP_SUMMARY
